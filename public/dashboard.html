<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard</title>
  <style>
    /* تخصيص الخطوط والألوان */
    :root {
      --primary: #7c3aed;
      --primary-light: #8b5cf6;
      --secondary: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --dark-bg: #0f172a;
      --dark-card: #1e293b;
      --dark-border: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --shadow: rgba(0, 0, 0, 0.3);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', 'Noto Sans Arabic', Tahoma, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--dark-bg);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(124, 58, 237, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(16, 185, 129, 0.1) 0%, transparent 20%);
    }
    
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* تحسين العناوين */
    h2 {
      font-size: 2rem;
      margin-bottom: 1.5rem;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
      display: inline-block;
    }
    
    h2::after {
      content: '';
      position: absolute;
      bottom: -8px;
      right: 0;
      width: 60%;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), transparent);
      border-radius: 3px;
    }
    
    h3 {
      font-size: 1.5rem;
      margin-bottom: 1.2rem;
      color: var(--text-primary);
      border-right: 4px solid var(--primary);
      padding-right: 12px;
    }
    
    /* تحسين الترويسة */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--dark-border);
    }
    
    /* تحسين الكروت */
    .card {
      background-color: var(--dark-card);
      border: 1px solid var(--dark-border);
      border-radius: 16px;
      padding: 24px;
      margin: 24px 0;
      box-shadow: 0 10px 25px var(--shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
    }
    
    /* تحسين حقول الإدخال */
    input, textarea {
      width: 100%;
      padding: 14px 16px;
      margin: 10px 0;
      font-size: 16px;
      background-color: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--dark-border);
      border-radius: 10px;
      color: var(--text-primary);
      transition: all 0.3s ease;
      font-family: inherit;
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
    }
    
    input::placeholder, textarea::placeholder {
      color: var(--text-muted);
    }
    
    /* تحسين الأزرار */
    button {
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    #add, #send {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      margin-top: 10px;
    }
    
    #add:hover, #send:hover {
      background: linear-gradient(135deg, var(--primary-light), var(--primary));
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(124, 58, 237, 0.3);
    }
    
    #refresh {
      background-color: rgba(16, 185, 129, 0.15);
      color: var(--secondary);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    #refresh:hover {
      background-color: rgba(16, 185, 129, 0.25);
      transform: translateY(-2px);
    }
    
    .danger {
      background: linear-gradient(135deg, var(--danger), #f87171);
      color: white;
    }
    
    .danger:hover {
      background: linear-gradient(135deg, #f87171, var(--danger));
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
    }
    
    /* تحسين الجدول */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    th {
      background-color: rgba(30, 41, 59, 0.8);
      padding: 18px 15px;
      text-align: right;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 2px solid var(--dark-border);
    }
    
    td {
      padding: 16px 15px;
      text-align: right;
      border-bottom: 1px solid var(--dark-border);
      color: var(--text-secondary);
    }
    
    tr {
      transition: background-color 0.2s ease;
    }
    
    tr:hover {
      background-color: rgba(30, 41, 59, 0.6);
    }
    
    /* تحسين الرسائل */
    #addMsg, #sendMsg, #listMsg {
      margin-top: 15px;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 500;
    }
    
    .ok {
      background-color: rgba(16, 185, 129, 0.15);
      color: #10b981;
      border-right: 4px solid #10b981;
    }
    
    .err {
      background-color: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border-right: 4px solid #ef4444;
    }
    
    /* تحسين النصوص الصغيرة */
    small {
      display: block;
      margin-top: 15px;
      color: var(--text-muted);
      font-size: 0.9rem;
      line-height: 1.5;
      padding: 10px 14px;
      background-color: rgba(30, 41, 59, 0.6);
      border-radius: 8px;
      border-right: 3px solid var(--warning);
    }
    
    /* تحسين الأزرار داخل الجدول */
    table button {
      padding: 10px 18px;
      font-size: 14px;
      margin: 0;
    }
    
    /* تحسين التمرير */
    ::-webkit-scrollbar {
      width: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--dark-card);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 5px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-light);
    }
    
    /* تحسين للشاشات الصغيرة */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      h2 {
        font-size: 1.7rem;
      }
      
      h3 {
        font-size: 1.3rem;
      }
      
      .card {
        padding: 18px;
      }
      
      table {
        display: block;
        overflow-x: auto;
      }
      
      button {
        padding: 12px 20px;
        font-size: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h2>لوحة التحكم</h2>
        <p style="color: var(--text-secondary); margin-top: 5px;">إدارة الأرقام والرسائل</p>
      </div>
      <button id="logout" class="danger">
        <span>تسجيل الخروج</span>
      </button>
    </div>

    <div class="card">
      <h3>إضافة رقم جديد</h3>
      <input id="phone" placeholder="اكتب الرقم (مثال: 01234567890)" />
      <button id="add">إضافة الرقم</button>
      <div id="addMsg"></div>
    </div>

    <div class="card">
      <h3>إرسال رسالة يدويًا</h3>
      <input id="sendPhone" placeholder="رقم الموبايل" />
      <textarea id="message" rows="4" placeholder="اكتب الرسالة هنا..."></textarea>
      <button id="send">إرسال الرسالة</button>
      <div id="sendMsg"></div>
      <small>
        ملاحظة: يجب على صاحب الرقم فتح البوت وإرسال الرقم مرة واحدة ليتم تسجيل chat_id.
      </small>
    </div>

    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px;">
        <h3 style="margin-bottom: 0;">قائمة الأرقام المسجلة</h3>
        <button id="refresh">تحديث القائمة</button>
      </div>
      <div id="listMsg"></div>
      <table>
        <thead>
          <tr>
            <th>الرقم</th>
            <th>تاريخ الإضافة</th>
            <th>الإجراءات</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    function normalizePhone(s){ return String(s||"").replace(/[^\d]/g,""); }

    async function api(url, options = {}) {
      const token = localStorage.getItem("jwt");
      const headers = { ...(options.headers || {}) };
      if (token) headers["Authorization"] = "Bearer " + token;

      const resp = await fetch(url, { ...options, headers });

      if (resp.status === 401) {
        localStorage.removeItem("jwt");
        location.href = "/login";
        return null;
      }
      return resp;
    }

    async function loadNumbers() {
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";
      const listMsg = document.getElementById("listMsg");
      listMsg.textContent = "";
      listMsg.className = "";

      const resp = await api("/api/numbers");
      if (!resp) return;

      const data = await resp.json().catch(()=>({}));
      const items = data.items || [];

      if (!items.length) {
        listMsg.textContent = "لا توجد أرقام مسجلة حالياً.";
        listMsg.className = "err";
        return;
      }

      for (const it of items) {
        const tr = document.createElement("tr");

        // عمود الرقم
        const tdPhone = document.createElement("td");
        const phoneDiv = document.createElement("div");
        phoneDiv.textContent = it.phone || "";
        phoneDiv.style.fontWeight = "500";
        phoneDiv.style.color = "var(--text-primary)";
        tdPhone.appendChild(phoneDiv);
        tr.appendChild(tdPhone);

        // عمود التاريخ
        const tdDate = document.createElement("td");
        tdDate.textContent = it.createdAt || "";
        tdDate.style.color = "var(--text-secondary)";
        tr.appendChild(tdDate);

        // عمود الإجراءات
        const tdActions = document.createElement("td");
        tdActions.style.display = "flex";
        tdActions.style.gap = "10px";
        tdActions.style.flexWrap = "wrap";
        
        // زر الاستخدام
        const useBtn = document.createElement("button");
        useBtn.textContent = "استخدام";
        useBtn.style.backgroundColor = "rgba(124, 58, 237, 0.15)";
        useBtn.style.color = "var(--primary-light)";
        useBtn.style.border = "1px solid rgba(124, 58, 237, 0.3)";
        useBtn.onclick = () => {
          document.getElementById("sendPhone").value = it.phone || "";
          document.getElementById("message").focus();
          window.scrollTo({ top: 0, behavior: "smooth" });
        };
        
        // زر الحذف
        const delBtn = document.createElement("button");
        delBtn.textContent = "حذف";
        delBtn.className = "danger";
        delBtn.onclick = async () => {
          if (!confirm(`هل أنت متأكد من حذف الرقم ${it.phone}؟`)) return;
          
          const phone = normalizePhone(it.phone);
          const r = await api("/api/numbers/" + phone, { method: "DELETE" });
          if (r && r.ok) loadNumbers();
        };
        
        tdActions.appendChild(useBtn);
        tdActions.appendChild(delBtn);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      }
    }

    document.getElementById("add").onclick = async () => {
      const phone = normalizePhone(document.getElementById("phone").value);
      const msg = document.getElementById("addMsg");
      msg.textContent = "";
      msg.className = "";

      if (!phone || phone.length < 10) { 
        msg.textContent = "الرجاء إدخال رقم صحيح (10 أرقام على الأقل)";
        msg.className="err"; 
        return; 
      }

      const resp = await api("/api/numbers", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ phone })
      });

      if (!resp) return;

      const data = await resp.json().catch(()=>({}));

      if (resp.ok) {
        msg.textContent = "تمت إضافة الرقم بنجاح ✅";
        msg.className = "ok";
        document.getElementById("phone").value = "";
        loadNumbers();
      } else {
        msg.textContent = (data.detail ? (data.error + " — " + data.detail) : (data.error || ("خطأ " + resp.status)));
        msg.className = "err";
      }
    };

    document.getElementById("send").onclick = async () => {
      const phone = normalizePhone(document.getElementById("sendPhone").value);
      const message = document.getElementById("message").value.trim();
      const msg = document.getElementById("sendMsg");
      msg.textContent = "";
      msg.className = "";

      if (!phone || phone.length < 10) { 
        msg.textContent="الرجاء إدخال رقم صحيح"; 
        msg.className="err"; 
        return; 
      }
      
      if (!message) { 
        msg.textContent="الرجاء كتابة نص الرسالة"; 
        msg.className="err"; 
        return; 
      }

      const resp = await api("/api/send", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ phone, message })
      });

      if (!resp) return;

      const data = await resp.json().catch(()=>({}));

      if (resp.ok) {
        msg.textContent = "تم إرسال الرسالة بنجاح ✅";
        msg.className = "ok";
        document.getElementById("message").value = "";
      } else {
        msg.textContent = (data.detail ? (data.error + " — " + data.detail) : (data.error || ("خطأ " + resp.status)));
        msg.className = "err";
      }
    };

    document.getElementById("refresh").onclick = loadNumbers;

    document.getElementById("logout").onclick = async () => {
      if (!confirm("هل تريد تسجيل الخروج؟")) return;
      
      await fetch("/api/auth/logout", { method: "POST" }).catch(()=>{});
      localStorage.removeItem("jwt");
      location.href = "/login";
    };

    // التحقق من وجود التوكن
    if (!localStorage.getItem("jwt")) {
      location.href = "/login";
    } else {
      loadNumbers();
    }
    
    // إضافة تأثيرات بصرية إضافية
    document.addEventListener('DOMContentLoaded', function() {
      const cards = document.querySelectorAll('.card');
      cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
      });
    });
  </script>
</body>
</html>

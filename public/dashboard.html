<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard</title>

  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --border: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.66);

      --brand: #5aa7ff;
      --brand2: #7c5cff;
      --ok: #39d98a;
      --danger: #ff5d5d;
      --warn: #ffcc66;

      --shadow: 0 16px 50px rgba(0,0,0,.45);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Arial, system-ui, -apple-system, "Segoe UI", Tahoma, sans-serif;
      background:
        radial-gradient(900px 500px at 85% -10%, rgba(124,92,255,.25), transparent 60%),
        radial-gradient(900px 500px at 10% 0%, rgba(90,167,255,.22), transparent 55%),
        linear-gradient(180deg, #08101f 0%, #070b14 100%);
      color:var(--text);
      padding:28px;
    }

    .wrap{ max-width: 980px; margin:0 auto; }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:18px;
    }

    h2{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .badge{
      font-size:12px;
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      color:var(--muted);
      background:rgba(255,255,255,.03);
    }

    .card{
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:18px;
      margin:14px 0;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    .card h3{
      margin:0 0 12px;
      font-size:16px;
      color: rgba(255,255,255,.92);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:start;
    }

    @media (max-width: 720px){
      .grid{ grid-template-columns: 1fr; }
    }

    label{ display:block; font-size:12px; color:var(--muted); margin:4px 0 6px; }

    input, textarea{
      width:100%;
      padding:12px 12px;
      font-size:15px;
      color: var(--text);
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      outline: none;
      transition: .15s ease;
    }
    input::placeholder, textarea::placeholder{ color: rgba(255,255,255,.45); }
    input:focus, textarea:focus{
      border-color: rgba(90,167,255,.55);
      box-shadow: 0 0 0 3px rgba(90,167,255,.18);
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    button{
      cursor:pointer;
      border:none;
      border-radius: 14px;
      padding:12px 14px;
      font-size:14px;
      color: rgba(255,255,255,.92);
      background: linear-gradient(135deg, rgba(90,167,255,.92), rgba(124,92,255,.92));
      box-shadow: 0 10px 26px rgba(90,167,255,.16);
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
      white-space:nowrap;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    button:active{ transform: translateY(0); opacity:.92; }

    .btn-ghost{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:none;
    }

    .btn-danger{
      background: rgba(255,93,93,.14);
      border:1px solid rgba(255,93,93,.35);
      box-shadow:none;
    }
    .btn-danger:hover{ filter: brightness(1.08); }

    .hint{
      margin-top:10px;
      color: var(--muted);
      font-size: 12px;
      line-height:1.5;
    }

    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--muted);
    }
    .msg.ok{
      border-color: rgba(57,217,138,.35);
      background: rgba(57,217,138,.10);
      color: rgba(255,255,255,.92);
    }
    .msg.err{
      border-color: rgba(255,93,93,.35);
      background: rgba(255,93,93,.12);
      color: rgba(255,255,255,.92);
    }

    .tableWrap{
      overflow:auto;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      margin-top:12px;
    }

    table{ width:100%; border-collapse:collapse; min-width: 620px; }
    th, td{
      padding:12px 12px;
      text-align:right;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:middle;
      font-size:14px;
    }
    th{
      position:sticky;
      top:0;
      background: rgba(10,16,30,.92);
      backdrop-filter: blur(8px);
      color: rgba(255,255,255,.78);
      font-weight:600;
    }
    tbody tr:hover{ background: rgba(255,255,255,.04); }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.85);
      font-size:12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <h2>لوحة التحكم <span class="badge">Dark ثابت</span></h2>
      <button id="logout" class="btn-danger">Logout</button>
    </div>

    <div class="card">
      <h3>إضافة رقم</h3>
      <div class="grid">
        <div>
          <label for="phone">الرقم</label>
          <input id="phone" placeholder="اكتب الرقم (مثال: 01234567890)" />
          <div id="addMsg"></div>
        </div>
        <div class="actions">
          <button id="add">إضافة</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>إرسال رسالة يدويًا</h3>
      <div class="grid">
        <div>
          <label for="sendPhone">رقم الموبايل</label>
          <input id="sendPhone" placeholder="رقم الموبايل" />
          <label for="message">الرسالة</label>
          <textarea id="message" rows="4" placeholder="اكتب الرسالة هنا..."></textarea>
          <div id="sendMsg"></div>

          <div class="hint">
            ملاحظة: لازم صاحب الرقم يفتح البوت ويبعت الرقم مرة واحدة عشان يتسجل chat_id.
          </div>
        </div>
        <div class="actions">
          <button id="send">إرسال</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <h3 style="margin:0">الأرقام</h3>
        <button id="refresh" class="btn-ghost">تحديث القائمة</button>
      </div>

      <div id="listMsg"></div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>الرقم</th>
              <th>تاريخ الإضافة</th>
              <th>حذف</th>
              <th>استخدام</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    function normalizePhone(s){ return String(s||"").replace(/[^\d]/g,""); }

    async function api(url, options = {}) {
      const token = localStorage.getItem("jwt");
      const headers = { ...(options.headers || {}) };
      if (token) headers["Authorization"] = "Bearer " + token;

      const resp = await fetch(url, { ...options, headers });

      if (resp.status === 401) {
        localStorage.removeItem("jwt");
        location.href = "/login";
        return null;
      }
      return resp;
    }

    function setMsg(el, text, kind){
      el.textContent = text || "";
      el.className = text ? ("msg " + (kind || "")) : "";
    }

    async function loadNumbers() {
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";
      setMsg(document.getElementById("listMsg"), "", "");

      const resp = await api("/api/numbers");
      if (!resp) return;

      const data = await resp.json().catch(()=>({}));
      const items = data.items || [];

      if (!items.length) {
        setMsg(document.getElementById("listMsg"), "لا توجد أرقام.", "");
        return;
      }

      for (const it of items) {
        const tr = document.createElement("tr");

        const tdPhone = document.createElement("td");
        tdPhone.innerHTML = `<span class="pill">${it.phone || ""}</span>`;
        tr.appendChild(tdPhone);

        const tdDate = document.createElement("td");
        tdDate.textContent = it.createdAt || "";
        tdDate.style.color = "rgba(255,255,255,.70)";
        tr.appendChild(tdDate);

        const tdDel = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.textContent = "حذف";
        delBtn.className = "btn-danger";
        delBtn.onclick = async () => {
          const phone = normalizePhone(it.phone);
          const r = await api("/api/numbers/" + phone, { method: "DELETE" });
          if (r && r.ok) loadNumbers();
        };
        tdDel.appendChild(delBtn);
        tr.appendChild(tdDel);

        const tdUse = document.createElement("td");
        const useBtn = document.createElement("button");
        useBtn.textContent = "استخدام";
        useBtn.className = "btn-ghost";
        useBtn.onclick = () => {
          document.getElementById("sendPhone").value = it.phone || "";
          window.scrollTo({ top: 0, behavior: "smooth" });
        };
        tdUse.appendChild(useBtn);
        tr.appendChild(tdUse);

        tbody.appendChild(tr);
      }
    }

    document.getElementById("add").onclick = async () => {
      const phone = normalizePhone(document.getElementById("phone").value);
      const msg = document.getElementById("addMsg");
      setMsg(msg, "", "");

      if (!phone) { setMsg(msg, "رقم غير صحيح", "err"); return; }

      const resp = await api("/api/numbers", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ phone })
      });

      if (!resp) return;

      const data = await resp.json().catch(()=>({}));

      if (resp.ok) {
        setMsg(msg, "تمت الإضافة ✅", "ok");
        document.getElementById("phone").value = "";
        loadNumbers();
      } else {
        const t = (data.detail ? (data.error + " — " + data.detail) : (data.error || ("HTTP " + resp.status)));
        setMsg(msg, t, "err");
      }
    };

    document.getElementById("send").onclick = async () => {
      const phone = normalizePhone(document.getElementById("sendPhone").value);
      const message = document.getElementById("message").value.trim();
      const msg = document.getElementById("sendMsg");
      setMsg(msg, "", "");

      if (!phone) { setMsg(msg,"رقم غير صحيح","err"); return; }
      if (!message) { setMsg(msg,"اكتب رسالة","err"); return; }

      const resp = await api("/api/send", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ phone, message })
      });

      if (!resp) return;

      const data = await resp.json().catch(()=>({}));

      if (resp.ok) {
        setMsg(msg, "تم الإرسال ✅", "ok");
      } else {
        const t = (data.detail ? (data.error + " — " + data.detail) : (data.error || ("HTTP " + resp.status)));
        setMsg(msg, t, "err");
      }
    };

    document.getElementById("refresh").onclick = loadNumbers;

    document.getElementById("logout").onclick = async () => {
      await fetch("/api/auth/logout", { method: "POST" }).catch(()=>{});
      localStorage.removeItem("jwt");
      location.href = "/login";
    };

    if (!localStorage.getItem("jwt")) {
      location.href = "/login";
    } else {
      loadNumbers();
    }
  </script>
</body>
</html>
